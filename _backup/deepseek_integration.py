"""
Integra√ß√£o com DeepSeek R1 0528 via OpenRouter para o ENEM AI Helper
Este arquivo cont√©m a configura√ß√£o para usar a LLM DeepSeek nos professores particulares.
"""

import streamlit as st
from openai import OpenAI
from typing import Dict, Optional
import time

class DeepSeekTeacher:
    """Classe para integra√ß√£o com DeepSeek R1 0528 via OpenRouter"""
    
    def __init__(self, api_key: str, site_url: str = "", site_name: str = "ENEM AI Helper"):
        """
        Inicializa o cliente DeepSeek
        
        Args:
            api_key (str): Chave da API do OpenRouter
            site_url (str): URL do seu site (opcional)
            site_name (str): Nome do seu site (opcional)
        """
        self.client = OpenAI(
            base_url="https://openrouter.ai/api/v1",
            api_key=api_key,
        )
        self.site_url = site_url
        self.site_name = site_name
        self.model = "deepseek/deepseek-r1-0528:free"
    
    def get_teacher_response(self, subject: str, message: str, teacher_name: str) -> str:
        """
        Obt√©m resposta do professor usando DeepSeek R1
        
        Args:
            subject (str): Mat√©ria do ENEM
            message (str): Pergunta da Sther
            teacher_name (str): Nome do professor
            
        Returns:
            str: Resposta do professor
        """
        
        # Prompts especializados para cada mat√©ria
        system_prompts = {
            "Matem√°tica": f"""Voc√™ √© o {teacher_name}, um professor particular brasileiro especializado em Matem√°tica para o ENEM. 
            Voc√™ ensina √°lgebra, geometria, estat√≠stica, an√°lise combinat√≥ria e matem√°tica aplicada de forma did√°tica e motivadora.
            Sua aluna √© Sther, uma jovem de 17 anos que est√° se preparando para o ENEM.
            
            Caracter√≠sticas do seu ensino:
            - Use analogias do cotidiano brasileiro
            - Explique passo a passo com clareza
            - Seja motivador e paciente
            - Relate conceitos com situa√ß√µes pr√°ticas
            - Use exemplos que uma adolescente brasileira entenderia
            - Sempre responda em portugu√™s brasileiro
            - Foque nos t√≥picos que caem no ENEM""",
            
            "L√≠ngua Portuguesa": f"""Voc√™ √© a {teacher_name}, uma professora particular brasileira especializada em L√≠ngua Portuguesa para o ENEM.
            Voc√™ ensina gram√°tica, literatura brasileira, interpreta√ß√£o de textos e an√°lise lingu√≠stica de forma envolvente.
            Sua aluna √© Sther, uma jovem de 17 anos que est√° se preparando para o ENEM.
            
            Caracter√≠sticas do seu ensino:
            - Use exemplos da literatura brasileira
            - Relacione gram√°tica com textos atuais
            - Seja carism√°tica e inspire amor pela l√≠ngua
            - Use refer√™ncias culturais brasileiras
            - Explique de forma clara e did√°tica
            - Sempre responda em portugu√™s brasileiro
            - Foque nos aspectos que o ENEM cobra""",
            
            "Biologia": f"""Voc√™ √© o {teacher_name}, um professor particular brasileiro especializado em Biologia para o ENEM.
            Voc√™ ensina biologia celular, gen√©tica, ecologia, evolu√ß√£o e fisiologia de forma curiosa e interessante.
            Sua aluna √© Sther, uma jovem de 17 anos que est√° se preparando para o ENEM.
            
            Caracter√≠sticas do seu ensino:
            - Relacione com a biodiversidade brasileira
            - Use exemplos da natureza do Brasil
            - Seja curioso e desperte interesse cient√≠fico
            - Conecte conceitos com o cotidiano
            - Explique processos de forma visual
            - Sempre responda em portugu√™s brasileiro
            - Foque nos temas do ENEM""",
            
            "Geografia": f"""Voc√™ √© a {teacher_name}, uma professora particular brasileira especializada em Geografia para o ENEM.
            Voc√™ ensina geografia f√≠sica, humana, geopol√≠tica e quest√µes ambientais com foco na realidade brasileira.
            Sua aluna √© Sther, uma jovem de 17 anos que est√° se preparando para o ENEM.
            
            Caracter√≠sticas do seu ensino:
            - Use exemplos do territ√≥rio brasileiro
            - Relacione com quest√µes socioambientais atuais
            - Conecte geografia com pol√≠tica e sociedade
            - Seja din√¢mica e atual
            - Use mapas mentais e compara√ß√µes
            - Sempre responda em portugu√™s brasileiro
            - Foque nos temas geogr√°ficos do ENEM""",
            
            "Hist√≥ria": f"""Voc√™ √© o {teacher_name}, um professor particular brasileiro especializado em Hist√≥ria para o ENEM.
            Voc√™ ensina hist√≥ria do Brasil, hist√≥ria geral e atualidades de forma interessante e contextualizada.
            Sua aluna √© Sther, uma jovem de 17 anos que est√° se preparando para o ENEM.
            
            Caracter√≠sticas do seu ensino:
            - Priorize a hist√≥ria do Brasil
            - Relacione passado com presente
            - Use cronologias e marcos temporais
            - Conte hist√≥rias envolventes
            - Conecte com quest√µes sociais atuais
            - Sempre responda em portugu√™s brasileiro
            - Foque nos per√≠odos hist√≥ricos do ENEM""",
            
            "Qu√≠mica": f"""Voc√™ √© a {teacher_name}, uma professora particular brasileira especializada em Qu√≠mica para o ENEM.
            Voc√™ ensina qu√≠mica org√¢nica, inorg√¢nica, f√≠sico-qu√≠mica e bioqu√≠mica de forma pr√°tica e interessante.
            Sua aluna √© Sther, uma jovem de 17 anos que est√° se preparando para o ENEM.
            
            Caracter√≠sticas do seu ensino:
            - Use experimentos mentais e analogias
            - Relacione qu√≠mica com o cotidiano
            - Explique rea√ß√µes e processos step-by-step
            - Seja entusiasta e mostre como a qu√≠mica √© fascinante
            - Use exemplos de produtos e materiais conhecidos
            - Sempre responda em portugu√™s brasileiro
            - Foque nos conceitos qu√≠micos do ENEM""",
            
            "F√≠sica": f"""Voc√™ √© o {teacher_name}, um professor particular brasileiro especializado em F√≠sica para o ENEM.
            Voc√™ ensina mec√¢nica, eletromagnetismo, ondulat√≥ria, termodin√¢mica e f√≠sica moderna de forma clara e aplicada.
            Sua aluna √© Sther, uma jovem de 17 anos que est√° se preparando para o ENEM.
            
            Caracter√≠sticas do seu ensino:
            - Use fen√¥menos f√≠sicos do dia a dia
            - Explique leis e f√≥rmulas com exemplos pr√°ticos
            - Seja paciente com c√°lculos e conceitos
            - Relacione f√≠sica com tecnologia atual
            - Use analogias e compara√ß√µes √∫teis
            - Sempre responda em portugu√™s brasileiro
            - Foque nos t√≥picos de f√≠sica do ENEM""",
            
            "Reda√ß√£o": f"""Voc√™ √© a {teacher_name}, uma professora particular brasileira especializada em Reda√ß√£o para o ENEM.
            Voc√™ ensina reda√ß√£o dissertativa-argumentativa, estrutura textual, argumenta√ß√£o e repert√≥rio sociocultural.
            Sua aluna √© Sther, uma jovem de 17 anos que est√° se preparando para o ENEM.
            
            Caracter√≠sticas do seu ensino:
            - Ensine a estrutura padr√£o do ENEM
            - Trabalhe argumenta√ß√£o s√≥lida e coesa
            - Desenvolva repert√≥rio sociocultural brasileiro
            - Incentive an√°lise cr√≠tica de temas sociais
            - Prepare para os 5 crit√©rios de avalia√ß√£o
            - Sempre responda em portugu√™s brasileiro
            - Foque na reda√ß√£o espec√≠fica do ENEM"""
        }
        
        # Seleciona o prompt apropriado para a mat√©ria
        system_prompt = system_prompts.get(subject, f"Voc√™ √© {teacher_name}, professor de {subject} especializado no ENEM.")
        
        try:
            # Headers opcionais para ranking no OpenRouter
            extra_headers = {}
            if self.site_url:
                extra_headers["HTTP-Referer"] = self.site_url
            if self.site_name:
                extra_headers["X-Title"] = self.site_name
            
            completion = self.client.chat.completions.create(
                extra_headers=extra_headers,
                extra_body={},
                model=self.model,
                messages=[
                    {
                        "role": "system",
                        "content": system_prompt
                    },
                    {
                        "role": "user", 
                        "content": f"Oi professor(a)! Tenho uma d√∫vida sobre {subject}: {message}"
                    }
                ],
                max_tokens=800,
                temperature=0.7,
                top_p=0.9
            )
            
            response = completion.choices[0].message.content
            return response if response else "Desculpe Sther, n√£o consegui processar sua pergunta. Pode tentar reformular?"
            
        except Exception as e:
            return f"Opa Sther! Estou com um probleminha t√©cnico aqui. Pode tentar novamente em alguns segundos? ü§ñüíô"

def setup_deepseek_config():
    """Configura a interface para inserir credenciais do DeepSeek"""
    
    st.sidebar.markdown("---")
    st.sidebar.markdown("### ü§ñ Configura√ß√£o DeepSeek R1")
    
    # Campo para API Key
    api_key = st.sidebar.text_input(
        "OpenRouter API Key:",
        type="password",
        help="Insira sua chave da API do OpenRouter"
    )
    
    # Campos opcionais
    with st.sidebar.expander("Configura√ß√µes Avan√ßadas (Opcional)"):
        site_url = st.text_input(
            "URL do seu site:",
            value="",
            help="Para ranking no OpenRouter (opcional)"
        )
        site_name = st.text_input(
            "Nome do seu site:",
            value="ENEM AI Helper",
            help="Para ranking no OpenRouter"
        )
    
    # Status da conex√£o
    if api_key:
        st.sidebar.success("‚úÖ API Key configurada!")
        
        # Teste de conex√£o
        if st.sidebar.button("üß™ Testar Conex√£o"):
            with st.sidebar.spinner("Testando..."):
                try:
                    teacher = DeepSeekTeacher(api_key, site_url, site_name)
                    test_response = teacher.get_teacher_response(
                        "Matem√°tica", 
                        "teste de conex√£o", 
                        "Prof. Carlos"
                    )
                    if "probleminha t√©cnico" not in test_response:
                        st.sidebar.success("üéâ Conex√£o OK!")
                    else:
                        st.sidebar.error("‚ùå Erro na conex√£o")
                except Exception as e:
                    st.sidebar.error(f"‚ùå Erro: {str(e)}")
    else:
        st.sidebar.warning("‚ö†Ô∏è Configure sua API Key")
    
    return api_key, site_url, site_name

def get_deepseek_response(subject: str, message: str, teacher_name: str, 
                         api_key: str, site_url: str = "", site_name: str = "ENEM AI Helper") -> str:
    """
    Fun√ß√£o principal para obter resposta do DeepSeek
    
    Args:
        subject (str): Mat√©ria
        message (str): Pergunta da Sther
        teacher_name (str): Nome do professor
        api_key (str): Chave da API
        site_url (str): URL do site (opcional)
        site_name (str): Nome do site (opcional)
        
    Returns:
        str: Resposta do professor
    """
    if not api_key:
        return "üîë Por favor, configure sua API Key do OpenRouter no painel lateral para usar o DeepSeek R1!"
    
    teacher = DeepSeekTeacher(api_key, site_url, site_name)
    return teacher.get_teacher_response(subject, message, teacher_name)

# Exemplo de como usar no app principal
def integration_instructions():
    """
    INSTRU√á√ïES PARA INTEGRAR NO APP.PY PRINCIPAL:
    
    1. Importe este m√≥dulo no in√≠cio do app.py:
       from deepseek_integration import setup_deepseek_config, get_deepseek_response
    
    2. Na fun√ß√£o main(), adicione a configura√ß√£o no sidebar:
       api_key, site_url, site_name = setup_deepseek_config()
    
    3. Substitua a fun√ß√£o get_teacher_response() por:
       
       def get_teacher_response(subject: str, message: str) -> str:
           teacher_name = SUBJECTS[subject]["teacher"]
           
           # Verifica se h√° API key configurada
           api_key = st.session_state.get('deepseek_api_key', '')
           site_url = st.session_state.get('deepseek_site_url', '')
           site_name = st.session_state.get('deepseek_site_name', 'ENEM AI Helper')
           
           if api_key:
               return get_deepseek_response(subject, message, teacher_name, api_key, site_url, site_name)
           else:
               # Fallback para resposta simulada
               return "üîë Configure sua API Key do OpenRouter para ativar os professores inteligentes!"
    
    4. No setup da configura√ß√£o, salve as vari√°veis no session_state:
       st.session_state['deepseek_api_key'] = api_key
       st.session_state['deepseek_site_url'] = site_url  
       st.session_state['deepseek_site_name'] = site_name
    """
    pass 